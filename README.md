<h1 align="center">Тестовое задание</h1>
<h2>Микросервис баланса пользователей.</h2>
Приложение хранит в себе идентификаторы пользователей и их баланс. Взаимодействие с ним осуществляется исключительно с помощью брокера очередей. 
По требованию внешней системы (общение между микросервисами через очередь сообщений), микросервис может выполнить одну из следующих операций со счетом пользователя: 
<ul>
    <li>Списание</li> 
    <li>Зачисление</li>
    <li>(будет плюсом, но не обязательно) Блокирование с последующим списанием или разблокированием. Заблокированные средства недоступны для использования. Блокировка означает что некая операция находится на авторизации и ждет какого-то внешнего подтверждения, ее можно впоследствии подтвердить или отклонить</li>  
    <li>Перевод от пользователя к пользователю</li>
</ul>
После проведения любой из этих операций генерируется событие. 
Основные требования к воркерам:
<ul>
    <li>Код воркеров должен безопасно выполняться параллельно в разных процессах;</li> 
    <li>Воркеры могут запускаться одновременно в любом числе экземпляров и выполняться произвольное время;</li> 
    <li>Все операции должны обрабатываться корректно, без двойных списаний.</li>
</ul>
Будет плюсом покрытие кода юнит-тестами. 
В пояснительной записке к выполненному заданию необходимо указать перечень используемых инструментов и технологий,  способ развертки приложения. 

Требования к окружению:
<ul>
    <li>Язык программирования: PHP >= 7, стандарт кодирования - PSR-12</li>
    <li>Можно использовать: любые фреймворки, реляционные БД для хранения баланса, брокеры очередей, key-value хранилища.</li>
</ul>

<h2>Используемые инструменты и технологии:</h2>
<ul>
    <li>Yii2 фреймворк</li>
    <li>Mysql</li>
    <li>Транхакции Mysql</li>
    <li>RabbitMQ</li>
    <li>Codeception</li>
    <li>Docker</li>
</ul>

<h2>Способ развертки приложения</h2>
1. Произвести подготовку: установить Composer и Docker
2. Склонировать проект из репозитория
3. Перейти в папку с проектом и запустить команду 
```shell
composer intsall
```
4. Запустить контейнеры баз данных в Докере командой
```shell
docker-compose up mysql mysql_test --build -d
```
* для последующих запусков достаточно будет
```shell
docker-compose up mysql mysql_test -d
```
5. Выполнить инициализацию с применением миграций
```shell
./yii init
```
6. Запустить остальные контейнеры
```shell
docker-compose up mysql mysql_test --build -d
```
7. Для завершения контейнеров воспользоваться командой
```shell
docker-compose down
```

<h2>О проекте и способах взаимодействия с ним</h2>
<ul>
    <li>Отслеживание работы очередей можжно осуществалять по адресу: http://localhost:15672/#/queues </li>
    <li>
        В процессе изначальной инициалзиации создается 10 пользователей для демонстрации работы программы
        Отключить можно замкомментировав commands/InitController.php:23 т.е. функцию $this->actionGenerateUsers();
    </li>
    <li>Так же для демонстрации был создан простейший генератор событий в commands/SenderController.php который по таймайуту шлет сообщения в очередь</li>
    <li>Поток сообщений разбит на 3 очереди: <i>credit_queue</i> - списание средств, <i>debit_queue</i> - зачисление средств, <i>transfer_queue</i> - перевод средств от одного пользователя другому. При этом результат каждой из операций отправляется в результирующую очередь <i>result_queue</i></li>
    <li>
        В проекте 3 типа воркеров, каждый из них работает со своей очередью. Нагрузку можно посмотреть масштабировав количество сендеров (или изменяя таймаут задержки отправки сообщений) и воркеров. Пример команды прямо в процессе выполнения программы:

```shell
docker-compose up --scale app=3 --scale worker1=3 --scale worker2=3 --scale worker3=4 -d
```
</li>
    <li>в .env параметрах можно изменить значение переменной RABBITMQ_CONSUMER_PAUSE - это задержка в микросекундах при генерации тестовых сообщений</li>
    <li>заупуск тестов осуществляется командой 

```shell
./vendor/bin/codecept run
```
</li>
</ul>
